# 测试指南

## 测试自动记录功能

### 测试步骤

1. **加载插件**
   - 在 UDT 中重新加载插件（如果已加载）
   - 在 Photoshop 中打开插件面板（`插件 > 保存历史`）

2. **测试场景1：新建文档**
   ```
   ✓ 在 Photoshop 中创建新文档
   ✓ 绘制一些内容
   ✓ 按 Ctrl+S 保存（第一次会弹出保存对话框）
   ✓ 选择位置和文件名，保存为 PSD
   ✓ 等待 1 秒
   ✓ 查看插件面板，应该能看到新记录
   ```

3. **测试场景2：修改已保存文档**
   ```
   ✓ 继续在刚才的文档中修改
   ✓ 再次按 Ctrl+S 保存
   ✓ 等待 1 秒
   ✓ 查看插件面板，缩略图应该更新了
   ```

4. **测试场景3：打开已有文档**
   ```
   ✓ 打开一个已存在的 PSD 文件
   ✓ 修改内容
   ✓ 按 Ctrl+S 保存
   ✓ 查看插件面板，应该出现新记录
   ```

5. **测试场景4：使用菜单保存**
   ```
   ✓ 修改文档
   ✓ 通过菜单 文件 > 存储 保存
   ✓ 查看插件面板，应该记录更新
   ```

6. **测试场景5：使用插件按钮保存**
   ```
   ✓ 修改文档
   ✓ 点击插件的"保存当前文档"按钮
   ✓ 应该弹出成功提示
   ✓ 查看插件面板，记录应该更新
   ```

7. **测试场景6：覆盖保存**
   ```
   ✓ 打开另一个文档（或新建）
   ✓ 修改内容
   ✓ 双击历史记录中的某个缩略图
   ✓ 确认覆盖
   ✓ 应该显示成功提示
   ✓ 被覆盖文件的缩略图应该更新
   ```

### 预期结果

✅ **正常情况：**
- 使用 Ctrl+S 保存后，历史面板会自动更新（无弹窗提示）
- 使用插件按钮保存后，会弹出成功提示
- 同一文件多次保存，会更新现有记录而非创建新记录
- 缩略图会显示最新的文档预览
- 时间显示为"刚刚"或相对时间

❌ **不会记录的情况：**
- 文档未保存就关闭（未触发保存事件）
- 使用"另存为"保存（路径改变）
- 保存失败（权限问题、磁盘满等）

### 调试方法

如果功能不正常，请检查：

1. **查看控制台日志**
   - 在插件面板上右键 > 检查元素
   - 打开开发者工具控制台
   - 查找相关日志：
     - `保存事件监听器已设置` - 监听器启动成功
     - `检测到保存事件` - 捕获到保存操作
     - `已记录文档到历史: [文件名]` - 记录成功
     - `文档未保存或无路径，跳过记录` - 新文档首次保存

2. **常见问题**

   **问题：保存后没有自动记录**
   - 解决：检查文档是否已保存过（新文档首次保存需要一个路径）
   - 解决：等待至少 1 秒（有 0.5 秒延迟）
   - 解决：查看控制台是否有错误信息

   **问题：缩略图显示空白**
   - 解决：文档可能太大，缩略图生成较慢
   - 解决：等待一会儿，刷新插件面板

   **问题：记录重复出现**
   - 解决：检查文件路径是否不同（可能是"另存为"）
   - 解决：大小写路径可能被识别为不同文件

3. **重置插件**
   - 点击"清空历史"按钮
   - 在 UDT 中重新加载插件
   - 重启 Photoshop

### 性能测试

- 打开大文件（>1GB）保存，观察缩略图生成速度
- 连续快速保存多次，观察是否有延迟
- 保存 50 个不同文件，检查是否正确限制在 50 条

### 兼容性测试

测试不同文件格式：
- PSD 文件 ✓
- JPG 文件 ✓
- PNG 文件 ✓
- TIFF 文件（如果保存路径正确应该也能记录）

---

## 开发者注意事项

### 关键代码位置

1. **事件监听器设置**
   ```javascript
   // index.js 中的 setupSaveListener() 函数
   action.addNotificationListener(['save'], async (event, descriptor) => {
       // 监听保存事件
   });
   ```

2. **记录逻辑**
   ```javascript
   // index.js 中的 recordDocumentToHistory() 函数
   // 处理文档信息记录
   ```

3. **智能更新**
   ```javascript
   // 检查路径是否已存在
   const existingIndex = history.findIndex(item => item.path === savedPath);
   // 如果存在则更新，否则新增
   ```

### 可能的改进

- [ ] 添加设置选项：是否启用自动记录
- [ ] 添加通知：保存后显示小提示（非模态）
- [ ] 优化缩略图生成性能
- [ ] 支持批量操作时的防抖处理
- [ ] 添加历史记录的搜索和筛选功能

