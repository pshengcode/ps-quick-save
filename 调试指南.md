# 🔧 调试指南 - 解决"看不到记录列表"问题

## 📋 快速诊断步骤

### 第一步：打开开发者工具

1. 在 Photoshop 中打开插件面板（`插件 > 保存历史`）
2. **右键点击**插件面板的任意位置
3. 选择 **"检查元素"** 或 **"Inspect Element"**
4. 开发者工具窗口会弹出，点击 **"Console"（控制台）** 标签

### 第二步：检查初始化日志

在控制台中，你应该看到类似这样的日志：

```
=== 插件初始化开始 ===
✅ 保存按钮已绑定
✅ 测试按钮已绑定
✅ 清空按钮已绑定
[监听器] 开始设置保存事件监听器...
[监听器] ✅ save 事件监听器已设置
[监听器] ✅ saveAs 事件监听器已设置
[监听器] 所有保存事件监听器设置完成
开始渲染缩略图...
[渲染] 开始渲染缩略图...
[渲染] 历史记录数量: 0
[渲染] 无历史记录，显示空状态
=== 插件初始化完成 ===
```

✅ **如果看到这些日志** - 插件初始化成功，继续下一步
❌ **如果看到错误** - 截图发送给开发者

### 第三步：测试记录功能

1. 在 Photoshop 中打开一个文档（或新建一个）
2. 如果是新文档，先 **按 Ctrl+S 保存一次**（选择位置和文件名）
3. 在插件面板中点击 **"测试记录"** 按钮
4. 查看控制台日志

**预期日志：**
```
=== 测试记录功能 ===
当前文档信息:
- 名称: 未命名-1.psd
- 路径: C:\Users\...\test.psd
- 已保存: true
- 宽度: 1920
- 高度: 1080
[记录] 开始记录文档，事件类型: 手动测试
[记录] 当前文档: test.psd, 路径: C:\...\test.psd, 已保存: true
[记录] 开始生成缩略图...
[记录] 缩略图生成完成
[记录] 添加新记录: test.psd
[渲染] 开始渲染缩略图...
[渲染] 历史记录数量: 1
[渲染] 渲染记录 1: test.psd
[渲染] 缩略图渲染完成
[记录] 记录完成: test.psd
```

✅ **如果看到这些日志并且面板显示缩略图** - 功能正常！
❌ **如果看到错误或没有缩略图** - 继续排查

### 第四步：测试自动保存监听

1. 修改当前打开的文档（画一笔、添加图层等）
2. **按 Ctrl+S 保存**
3. 等待 1-2 秒
4. 查看控制台日志

**预期日志：**
```
[监听器] ✅ 检测到 save 事件!
[监听器] 事件详情: save {...}
[记录] 开始记录文档，事件类型: save
[记录] 当前文档: test.psd, 路径: C:\...\test.psd, 已保存: true
[记录] 开始生成缩略图...
[记录] 缩略图生成完成
[记录] 更新现有记录: test.psd
[渲染] 开始渲染缩略图...
[渲染] 历史记录数量: 1
[渲染] 缩略图渲染完成
```

✅ **如果看到这些日志** - 自动监听成功！
❌ **如果没有看到 "检测到 save 事件"** - 监听器未工作，继续下一步

## 🐛 常见问题及解决方案

### 问题1：点击"测试记录"提示"文档还未保存过"

**原因**：新建的文档还没有文件路径

**解决**：
1. 按 Ctrl+S 保存文档
2. 选择保存位置和文件名
3. 再次点击"测试记录"

### 问题2：控制台显示 "文档无路径，跳过记录"

**原因**：文档没有保存过，或者保存失败了

**解决**：
1. 确保文档已成功保存（标题栏没有 * 号）
2. 检查文档路径：在控制台输入 `app.activeDocument.path` 查看
3. 如果返回 null 或 undefined，需要先保存文档

### 问题3：按 Ctrl+S 后没有看到 "检测到 save 事件"

**原因**：事件监听器可能未正确设置（可能是 UXP 版本兼容问题）

**临时解决方案**：
1. 使用插件的 **"保存当前文档"** 按钮代替 Ctrl+S
2. 或使用 **"测试记录"** 按钮手动记录

**永久解决**：需要检查 Photoshop 和 UXP 版本兼容性

### 问题4：缩略图显示为空白或加载失败

**原因**：文档过大或缩略图生成失败

**解决**：
1. 检查控制台是否有错误信息
2. 尝试较小的文档（<500MB）
3. 确保文档是支持的格式（PSD/JPG/PNG）

### 问题5：历史记录突然消失了

**原因**：localStorage 被清除

**解决**：
1. 不要清除浏览器缓存
2. 定期导出重要的历史记录（目前需要手动截图）
3. 未来版本会添加导出功能

## 🔍 高级调试

### 手动检查 localStorage

在控制台输入：
```javascript
console.log(localStorage.getItem('saveHistory'));
```

**如果返回 null** - 没有历史记录
**如果返回 JSON 字符串** - 有历史记录，但可能渲染有问题

### 手动添加测试记录

在控制台输入：
```javascript
localStorage.setItem('saveHistory', JSON.stringify([{
    id: '1',
    filename: '测试.psd',
    path: 'C:\\test.psd',
    timestamp: Date.now(),
    width: 1920,
    height: 1080,
    thumbnail: 'data:image/jpeg;base64,/9j/4AAQ...'
}]));
location.reload();
```

然后重新加载插件，看是否显示测试记录。

### 检查 Photoshop 版本

在控制台输入：
```javascript
console.log('Photoshop 版本:', app.version);
console.log('UXP 版本:', require('uxp').versions);
```

确保版本符合要求：
- Photoshop: >= 22.1.0
- UXP: >= 4.1.4

## 📞 获取帮助

如果以上步骤都无法解决问题，请提供以下信息：

1. **控制台完整日志**（从 "=== 插件初始化开始 ===" 到结束）
2. **Photoshop 版本号**
3. **操作系统**（Windows/Mac 及版本）
4. **具体操作步骤**
5. **错误截图**

---

## ✅ 快速测试清单

- [ ] 打开开发者工具控制台
- [ ] 看到 "插件初始化完成" 日志
- [ ] 新建或打开文档
- [ ] 按 Ctrl+S 保存（首次需要选择位置）
- [ ] 点击"测试记录"按钮
- [ ] 控制台显示 "记录完成" 日志
- [ ] 插件面板显示缩略图
- [ ] 修改文档后再次按 Ctrl+S
- [ ] 缩略图自动更新

如果所有步骤都成功，功能正常！🎉

