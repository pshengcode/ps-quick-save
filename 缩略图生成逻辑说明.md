# 📸 缩略图生成逻辑详解

## 🔀 双策略架构

插件使用**两套缩略图生成策略**，根据 Photoshop 版本自动选择：

```
generateThumbnail()
    ↓
    检测 executeAsModal 是否可用？
    ↓
    ├─ 可用 → 方法1：完整方法（缩放后保存）
    └─ 不可用 → 方法2：简化方法（原尺寸保存）
```

---

## 🎯 方法1：完整方法（推荐，新版本）

**适用版本**：Photoshop 24.0+，UXP 6.0+

### 流程图

```
1. 创建临时文件
   ↓
2. 保存当前历史状态
   ↓
3. 计算缩放比例（最大300px）
   ↓
4. 缩小图像尺寸（如需要）
   ↓
5. 保存为 JPEG（质量8）
   ↓
6. 撤销缩放操作（恢复原尺寸）
   ↓
7. 读取文件转为 base64
   ↓
8. 删除临时文件
   ↓
9. 返回 base64 图片
```

### 详细代码逻辑

```javascript
async function generateThumbnail() {
    // 使用 executeAsModal 确保操作安全
    return await executeAsModal(async () => {
        // 步骤1: 创建临时文件
        const tempFolder = await localFileSystem.getTemporaryFolder();
        const tempFile = await tempFolder.createFile(`thumb_${Date.now()}.jpg`);
        
        // 步骤2: 保存历史状态（用于后续恢复）
        const historyState = await batchPlay([{
            _obj: "get",
            _target: [{ _property: "currentHistoryState" }]
        }], {});
        
        // 步骤3: 计算缩放比例
        const maxSize = 300;  // 最大尺寸 300px
        const ratio = Math.min(maxSize / doc.width, maxSize / doc.height);
        
        // 步骤4: 如果图像大于300px，先缩小
        if (ratio < 1) {  // ratio < 1 表示需要缩小
            await batchPlay([{
                _obj: "imageSize",
                width: { _value: Math.round(doc.width * ratio) },
                height: { _value: Math.round(doc.height * ratio) },
                resolution: { _value: 72 },  // 72 DPI
                interfaceIconFrameDimmed: { _value: "bicubic" }  // 双三次插值
            }], {});
        }
        
        // 步骤5: 保存为 JPEG
        await batchPlay([{
            _obj: "save",
            as: { _obj: "JPEG", quality: 8 },  // 质量 8/12（中低质量）
            in: { _path: tempFile.nativePath },
            copy: true  // 作为副本保存，不影响原文档
        }], {});
        
        // 步骤6: 撤销缩放（恢复原尺寸）
        if (ratio < 1) {
            await batchPlay([{ _obj: "undo" }], {});
        }
        
        // 步骤7: 读取并转换为 base64
        const arrayBuffer = await tempFile.read();
        const base64 = arrayBufferToBase64(arrayBuffer);
        
        // 步骤8: 删除临时文件
        await tempFile.delete();
        
        // 步骤9: 返回 data URL
        return `data:image/jpeg;base64,${base64}`;
    });
}
```

### ✅ 优点
- 缩略图文件小（最大 300×300px）
- 质量适中，清晰度够用
- 不影响原文档（自动撤销）
- 内存占用少

### ❌ 缺点
- 需要 executeAsModal API
- 操作步骤较多
- Photoshop 22.1.0 不支持

---

## 🎯 方法2：简化方法（兼容，旧版本）

**适用版本**：Photoshop 22.1.0+，UXP 4.1.4+

### 流程图

```
1. 创建临时文件
   ↓
2. 直接保存文档为 JPEG（原尺寸）
   ↓
3. 读取文件转为 base64
   ↓
4. 删除临时文件
   ↓
5. 返回 base64 图片
```

### 详细代码逻辑

```javascript
async function generateThumbnailSimple() {
    // 步骤1: 创建临时文件
    const tempFolder = await localFileSystem.getTemporaryFolder();
    const tempFile = await tempFolder.createFile(`thumb_${Date.now()}.jpg`);
    
    // 步骤2: 直接保存为 JPEG（原尺寸，不缩放）
    await batchPlay([{
        _obj: "save",
        as: { _obj: "JPEG", quality: 8 },  // 质量 8/12
        in: { _path: tempFile.nativePath },
        copy: true  // 作为副本，不影响原文档
    }], {});
    
    // 步骤3: 读取并转换为 base64
    const arrayBuffer = await tempFile.read({ format: storage.formats.binary });
    const base64 = arrayBufferToBase64(arrayBuffer);
    
    // 步骤4: 删除临时文件
    await tempFile.delete();
    
    // 步骤5: 返回 data URL
    return `data:image/jpeg;base64,${base64}`;
}
```

### ✅ 优点
- 兼容性好（Photoshop 22.1.0+）
- 不需要 executeAsModal
- 步骤简单，不容易出错
- 代码清晰易懂

### ❌ 缺点
- **缩略图是原尺寸**（如果原图很大，文件也会很大）
- localStorage 空间占用大
- 如果文档是 4K (3840×2160)，缩略图也是 4K
- 大量历史记录可能超出 localStorage 限制

---

## 📊 两种方法对比

| 特性 | 完整方法 | 简化方法 |
|------|---------|---------|
| **版本要求** | PS 24.0+, UXP 6.0+ | PS 22.1.0+, UXP 4.1.4+ |
| **缩略图尺寸** | 最大 300×300px | 原图尺寸 |
| **文件大小** | 5-20 KB | 50-500 KB（取决于原图） |
| **质量** | 中等（够用） | 中等（相同质量设置） |
| **速度** | 较慢（需缩放+撤销） | 较快（直接保存） |
| **内存占用** | 小 | 大 |
| **localStorage占用** | 小 | 可能很大 |
| **最大历史数** | 50条没问题 | 可能达不到50条 |

---

## 🔧 关键参数说明

### 1. 缩略图最大尺寸
```javascript
const maxSize = 300;  // 可以修改
```
- 当前设置：300×300px
- 建议范围：150-500px
- 太小：看不清细节
- 太大：文件大，localStorage 占用多

### 2. JPEG 质量
```javascript
quality: 8  // 范围 0-12
```
- 当前设置：8/12（中低质量）
- 质量 0-4：低质量，文件小，模糊
- 质量 5-8：中质量，平衡
- 质量 9-12：高质量，文件大，清晰

### 3. 分辨率
```javascript
resolution: { _value: 72 }  // DPI
```
- 当前设置：72 DPI（屏幕标准）
- 72 DPI：适合屏幕显示
- 300 DPI：适合打印（但缩略图不需要）

### 4. 插值方法
```javascript
interfaceIconFrameDimmed: { _value: "bicubic" }
```
- `bicubic`：双三次插值（推荐，质量好）
- `bilinear`：双线性（速度快，质量中）
- `nearestNeighbor`：最近邻（速度最快，质量差）

---

## 🎨 base64 转换逻辑

```javascript
// 读取文件为 ArrayBuffer
const arrayBuffer = await tempFile.read({ format: storage.formats.binary });

// 转换为 Uint8Array
const uint8Array = new Uint8Array(arrayBuffer);

// 转换为二进制字符串
let binary = '';
for (let i = 0; i < uint8Array.length; i++) {
    binary += String.fromCharCode(uint8Array[i]);
}

// 编码为 base64
const base64 = btoa(binary);

// 生成 data URL
return `data:image/jpeg;base64,${base64}`;
```

**为什么用 base64？**
- 可以直接在 HTML `<img>` 标签中使用
- 存储在 localStorage 中（纯文本）
- 不需要额外的文件管理
- 跨平台兼容性好

---

## 💾 存储逻辑

缩略图存储在 localStorage 中：

```javascript
{
    id: "1734432000000",
    filename: "document.psd",
    path: "E:\\..\\document.psd",
    timestamp: 1734432000000,
    width: 1920,
    height: 1080,
    thumbnail: "data:image/jpeg;base64,/9j/4AAQSkZJRg..."  // base64图片
}
```

### localStorage 限制
- 大多数浏览器：5-10 MB
- 每条记录（简化方法）：50-500 KB
- 最多存储：约 10-100 条记录
- 超出限制：存储失败

---

## 🔍 当前你的版本使用哪种方法？

**Photoshop 22.1.0 + UXP 4.1.4**

→ **使用简化方法** (`generateThumbnailSimple`)

因为：
```javascript
const executeAsModal = photoshop.core.executeAsModal;

if (!executeAsModal) {  // ← 在你的版本中这个是 undefined
    return await generateThumbnailSimple();  // ← 走这里
}
```

控制台日志：
```
[缩略图] executeAsModal 不可用，使用简化方法
[缩略图] 使用简化方法生成缩略图
```

---

## 🚀 优化建议

### 1. 如果你的文档都很大（>2000px）

可以在简化方法中添加手动缩放：

```javascript
// 在简化方法保存前先用 CSS 缩放
// 或者在显示时用 CSS 限制大小
```

### 2. 限制历史记录数量

```javascript
// 从 50 条减少到 20 条
if (history.length > 20) {  // 原来是 50
    history.pop();
}
```

### 3. 降低 JPEG 质量

```javascript
quality: 6  // 从 8 降到 6，文件更小
```

### 4. 升级 Photoshop

升级到 Photoshop 24.0+ 可以使用完整方法，缩略图会小很多。

---

## 📝 总结

**当前你的环境（PS 22.1.0）：**
- ✅ 使用**简化方法**
- ✅ 缩略图是**原图尺寸**
- ✅ JPEG 质量 8/12
- ✅ 直接保存，无缩放
- ⚠️ 如果原图是 512×512，缩略图也是 512×512
- ⚠️ 文件可能较大（50-500 KB/张）
- ⚠️ localStorage 可能存不了太多

**工作流程：**
```
文档 (512×512) 
  ↓
保存为 JPEG (512×512, 质量8)
  ↓  
转为 base64
  ↓
存入 localStorage
  ↓
显示在界面（CSS 控制显示大小为 150px）
```

插件在界面上用 CSS 将缩略图限制为 120px 高度显示，但实际存储的是完整尺寸！

