# 🔧 缩略图错误修复 - "invalid file token used"

## 🐛 错误分析

### 错误信息
```
Error: invalid file token used
```

### 发生位置
在 `generateThumbnailSimple()` 函数中，尝试保存或读取临时文件时。

### 可能原因

1. **临时文件过早被删除或失效**
   - 文件句柄在操作完成前就失效了
   
2. **文件路径问题**
   - Windows 路径格式问题
   - 特殊字符处理
   
3. **batchPlay 参数问题**
   - JPEG 保存参数不正确
   - Photoshop 22.1.0 版本不支持某些参数

4. **异步操作竞争**
   - 文件还没写完就尝试读取
   - 多个操作同时访问同一文件

## ✅ 已实施的修复

### 1. 改进临时文件管理

**修改前：**
```javascript
const tempFile = await tempFolder.createFile(`thumb_${Date.now()}.jpg`);
```

**修改后：**
```javascript
// 添加随机字符串确保唯一性
const fileName = `ps_thumb_${Date.now()}_${Math.random().toString(36).substr(2, 9)}.jpg`;
tempFile = await tempFolder.createFile(fileName, { overwrite: true });
console.log('[缩略图] 临时文件创建成功:', tempFile.nativePath);
```

### 2. 优化 JPEG 保存参数

**修改前：**
```javascript
await batchPlay([{
    _obj: "save",
    as: { _obj: "JPEG", quality: 8 },
    in: { _path: tempFile.nativePath, _kind: "local" },
    copy: true
}], {});
```

**修改后：**
```javascript
await batchPlay([{
    _obj: "save",
    as: {
        _obj: "JPEG",
        extendedQuality: 8,  // 使用 extendedQuality 而不是 quality
        matteColor: {        // 添加背景色（处理透明）
            _obj: "RGBColor",
            red: 255,
            green: 255,
            blue: 255
        }
    },
    in: {
        _path: tempFile.nativePath,
        _kind: "local"
    },
    copy: true,
    lowerCase: true          // 强制小写扩展名
}], {
    modalBehavior: "fail"    // 如果需要用户交互就失败
});
```

### 3. 添加等待时间

```javascript
// 保存完成后等待文件写入
await new Promise(resolve => setTimeout(resolve, 100));

// 然后再读取文件
const arrayBuffer = await tempFile.read();
```

### 4. 增强错误处理和日志

```javascript
// 每个步骤都有详细日志
console.log('[缩略图] 临时文件夹获取成功');
console.log('[缩略图] 创建临时文件:', fileName);
console.log('[缩略图] 临时文件创建成功:', tempFile.nativePath);
console.log('[缩略图] 开始保存 JPEG...');
console.log('[缩略图] JPEG 保存完成');
console.log('[缩略图] 开始读取文件...');
console.log('[缩略图] 文件读取成功，大小:', arrayBuffer.byteLength);

// 详细的错误信息
console.error('[缩略图] 错误详情:', error.message, error.stack);
```

### 5. 添加三级备用方案

```
方案1: generateThumbnail() 
  ↓ executeAsModal 不可用
  
方案2: generateThumbnailSimple()
  ↓ 临时文件操作失败
  
方案3: generateThumbnailFallback()
  ↓ 返回 SVG 占位符
```

**备用方案代码：**
```javascript
async function generateThumbnailFallback() {
    // 生成一个简单的 SVG 占位符
    const placeholder = `<svg width="300" height="300">
        <rect fill="#333"/>
        <text>PSD</text>
    </svg>`;
    
    return `data:image/svg+xml;base64,${base64}`;
}
```

## 🧪 测试步骤

### 1. 重新加载插件
在 UDT 中刷新插件

### 2. 打开控制台
右键插件面板 > 检查元素 > Console

### 3. 点击"测试记录"
打开一个已保存的文档，点击"测试记录"按钮

### 4. 观察详细日志

**成功的日志应该是：**
```
[缩略图] 使用简化方法生成缩略图
[缩略图] 临时文件夹获取成功
[缩略图] 创建临时文件: ps_thumb_1734567890_abc123.jpg
[缩略图] 临时文件创建成功: C:\Users\...\Temp\ps_thumb_1734567890_abc123.jpg
[缩略图] 开始保存 JPEG...
[缩略图] JPEG 保存完成
[缩略图] 开始读取文件...
[缩略图] 文件读取成功，大小: 85432 bytes
[缩略图] base64 转换完成，长度: 114056
[缩略图] 临时文件已删除
[记录] 缩略图生成完成
```

**如果还是失败，会使用备用方案：**
```
[缩略图] 简化方法失败: Error: ...
[缩略图] 简化方法失败，使用备用方案
[缩略图] 使用极简备用方案
[缩略图] 占位符 SVG 生成成功
```

### 5. 查看插件面板

即使缩略图生成失败，也会显示占位符（灰色方块+PSD文字）

## 🔍 如果还是出错

### 诊断步骤

1. **查看临时文件路径**
   - 日志中会显示 `tempFile.nativePath`
   - 检查该路径是否可写
   - 检查磁盘空间

2. **检查 Photoshop 权限**
   - 确保 Photoshop 有文件系统访问权限
   - Windows: 检查用户账户控制(UAC)设置

3. **测试手动保存**
   - 在 Photoshop 中手动 `文件 > 存储为` JPEG
   - 看是否成功
   - 如果失败，可能是文档本身的问题

4. **查看完整错误堆栈**
   - 控制台会显示 `error.message` 和 `error.stack`
   - 把完整错误信息发给开发者

### 可能的解决方案

**如果是权限问题：**
- 以管理员身份运行 Photoshop
- 检查临时文件夹权限

**如果是文档格式问题：**
- 尝试不同的文档
- 确保文档已正确保存
- 尝试先合并图层

**如果是 Photoshop 版本问题：**
- 升级到最新版本（24.0+）
- 或暂时使用占位符（不影响其他功能）

## 📊 功能降级方案

即使缩略图完全失败，其他功能仍然可用：

✅ **仍然可用的功能：**
- 保存文档
- 记录历史（只是没有缩略图）
- 查看文件名、路径、尺寸、时间
- 双击覆盖保存
- 删除历史记录

❌ **不可用的功能：**
- 缩略图预览（显示占位符）

## 🎨 占位符显示效果

如果缩略图生成失败，会显示：

```
┌─────────────┐
│             │
│             │
│     PSD     │  ← 灰色背景 + "PSD" 文字
│             │
│             │
└─────────────┘
文件名.psd
5分钟前
1920 × 1080
```

虽然没有预览图，但功能完全正常！

## 📝 下一步

1. **重新加载插件**
2. **测试"测试记录"按钮**
3. **查看控制台日志**
4. **告诉我详细的日志内容**

特别关注：
- 临时文件路径是什么？
- 在哪一步失败？
- 完整的错误信息是什么？

---

让我们一步步解决这个问题！🔍

